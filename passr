#!/bin/bash
# Get passwords from a list
# by Evan Teitelman <teitelmanevan@gmail.com>

# override with -c
xselection=primary
# override with -p
print_mode=false
dir=$HOME/pass

enc "$dir"
pattern=$1
shift
res=$(grep "[^ ]*$pattern" "$dir/pass")
if [[ -z "$res" ]] ; then
	echo >&2 'no results!'
	exit 1
fi
nres=$(wc -l <<< "$res")

for arg ; do
	case "$arg" in
		-c) xselection=clipboard ;;
		-p) print_mode=true ;;
	esac
done

if (( $nres > 1 )) ; then
	mapfile -t results <<< "$res"
	echo 'select one:'
	for i in $(seq 1 ${#results[@]}) ; do
		line=${results[$(( i - 1 ))]}
		echo "$i: $(cut -d' ' -f1,2 <<< $line )"
	done
	echo -n '> '
	read n
	res=${results[$(( n - 1))]}
fi

service=$(cut -d' ' -f1 <<< "$res")
user=$(cut -d' ' -f2 <<< "$res")
pass=$(cut -d' ' -f3 <<< "$res")
if $print_mode ; then
	echo "$service"$'\t'"$user"$'\t'"$pass"
else
	echo "service: $service"
	echo "user: $user"
	echo "password copied to $xselection"
	xclip -selection $xselection <<< $pass
fi
