#!/bin/sh

set -e -u

mnt_dir=/mnt/bu

cleanup() {
	umount "$mnt_dir"
	rmdir "$mnt_dir"
	mount -o rw,remount /home
}

trap cleanup EXIT

mkdir -p "$mnt_dir"

cryptsetup --type=tcrypt open /dev/sdc1 bu
mount /dev/mapper/bu /mnt

mount -o ro,remount /home

rsync -av --progress --fuzzy --delete-before \
  /home/ /mnt
